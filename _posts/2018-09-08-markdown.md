---
layout: post
title: Go与C/C++函数返回局部变量地址
date: 2018-09-08
categories: skill
tags: go c++ 逃逸分析 堆栈
---

# Go与C/C++语言函数返回局部变量地址

#### 1.C/C++语言返回函数中的局部变量值和指针

* c语言中，一个函数可以直接返回函数定义的局部变量。函数返回后，局部变量是被系统回收的，因为局部变量被分配在栈上。能够返回是因为返回的是局部变量的副本（拷贝）。
* 函数返回局部变量地址会发生错误。因为局部变量内存分配在栈空间，函数返回后，系统自动回收了局部变量。要解决，即使内存空间分配在堆上。例如malloc、new.

#### 2.Go语言函数中返回变量，指针

​      go语言编译器会自动决定把一个变量放在栈上还是堆。编译器做逃逸分析(escape analysis)，当发现变量的作用域没有跑出函数范围，就可以放在栈上，反之则必须分配在堆。所以不用担心memory leak.

​	对于动态new出来的局部变量，go语言编译器也会根据是否有逃逸行为来决定是分配在堆还是栈，而不是直接分配在堆中。

